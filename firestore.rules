rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. 使用者設定檔 (Users Collection)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 2. 帳本資料 (Ledgers Collection)
    match /artifacts/{appId}/public/data/ledgers/{ledgerId} {
      
      // 輔助函式：檢查請求者是否已經在該帳本的 users 名單中
      function isMember() {
        return request.auth.uid in resource.data.users;
      }
      
      // 輔助函式：檢查是否為建立新帳本
      function isCreating() {
        return request.resource.data.users[request.auth.uid].role == 'host';
      }

      // [FIX] 輔助函式：檢查是否為加入帳本 (Join)
      // 允許非成員進行 update，但只能是在 users 欄位中新增自己
      function isJoining() {
        // 確保請求者把自己加進 users，且角色是 guest
        return request.resource.data.users[request.auth.uid].role == 'guest'
            // 確保沒有竄改現有使用者的資料 (簡單檢查: 新資料的 keys 包含舊資料的 keys)
            // 注意：完整的 diff 檢查在 Rules 中較複雜，這裡先做基本權限放行
            && request.resource.data.users.size() == resource.data.users.size() + 1;
      }

      // 讀取: 成員可讀
      allow read: if request.auth != null && isMember();

      // 寫入: 
      // 1. 建立 (Create)
      // 2. 更新 (Update): 是成員 OR 是新成員正在加入 (isJoining)
      allow create: if request.auth != null && isCreating();
      allow update: if request.auth != null && (isMember() || isJoining());
      
      // 刪除: 只有 Host 能刪除
      allow delete: if request.auth != null 
                    && isMember() 
                    && resource.data.users[request.auth.uid].role == 'host';
    }
  }
}
