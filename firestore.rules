rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. User Profile (Self-only)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 2. Ledger Data
    match /artifacts/{appId}/public/data/ledgers/{ledgerId} {
      
      // --- Helpers ---
      
      function isLoggedIn() {
        return request.auth != null;
      }
      
      function getMyRole() {
        // Safe access to role
        return resource.data.users[request.auth.uid].role;
      }

      function isMember() {
        return isLoggedIn() && (request.auth.uid in resource.data.users);
      }
      
      function isHost() {
        return isMember() && getMyRole() == 'host';
      }
      
      // Check if the update is only touching 'transactions' or 'subscriptions' (common operations)
      function isDataUpdate() {
        // Allow members to update transactions/subscriptions/projects
        // BUT prevent them from touching 'users' or 'settings' unless allowed below
        return request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['transactions', 'subscriptions', 'projects', 'lastSubscriptionCheck', 'customCategories']);
      }

      function isJoining() {
        // 1. Check if adding self to users
        let newUsers = request.resource.data.users;
        let oldUsers = resource.data.users;
        
        return !isMember() 
            && newUsers.size() == oldUsers.size() + 1
            && newUsers[request.auth.uid].role == 'guest' // Must join as guest
            // Ensure no other data is changed during join
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['users']);
      }

      function isLeaving() {
        // 1. Check if removing self from users
        let newUsers = request.resource.data.users;
        let oldUsers = resource.data.users;
        
        return isMember()
            && newUsers.size() == oldUsers.size() - 1
            && !(request.auth.uid in newUsers) // I am gone
            // Ensure no other data is changed during leave
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['users']);
      }

      function isHostManagement() {
        // Host can do anything via update (kick members, change settings)
        return isHost();
      }

      // --- Rules ---

      // Read: Any member can read
      allow read: if isMember();

      // Create: Anyone can create (becomes Host automatically by app logic, verified here)
      allow create: if isLoggedIn() 
                    && request.resource.data.users[request.auth.uid].role == 'host';

      // Update: Complex Logic
      allow update: if isLoggedIn() && (
        isHostManagement() || // Host has full power
        isJoining() ||        // Guest joining
        isLeaving() ||        // Guest leaving
        (isMember() && isDataUpdate()) // Guest/Member adding transactions
      );
      
      // Delete: Only Host
      allow delete: if isHost();

      // 3. Transactions Sub-collection (SCALABILITY FIX)
      match /transactions/{txId} {
        // Helper to fetch parent ledger data (cost: 1 read)
        function getLedger() {
          return get(/databases/$(database)/documents/artifacts/$(appId)/public/data/ledgers/$(ledgerId)).data;
        }

        function isLedgerMember() {
          return isLoggedIn() && (request.auth.uid in getLedger().users);
        }

        allow read: if isLedgerMember();
        allow create: if isLedgerMember();
        allow update: if isLedgerMember();
        allow delete: if isLedgerMember();
      }
    }
  }
}
