import{r,e as ge,d as se,D as U,C as z,g as ye,a as be,j as e,h as ae,i as je,U as ve,L as Ne}from"./index-Baq4XpNT.js";import{X as le}from"./x-yUZdy7kV.js";import{U as Se}from"./users-BpHtjguB.js";import{C as we}from"./credit-card-CiAc-Rsg.js";import{T as Ce}from"./trash-2-uDwVWSjG.js";import{R as ke}from"./refresh-cw-AiDy8ZY_.js";import{C as ze}from"./check-Dao14EYj.js";import{S as Te,C as Fe}from"./search-WnupCDoo.js";function Me({isOpen:re,onClose:N,editingTx:a,ledgerData:c,user:f,updateTransaction:ne,deleteTransaction:oe,currentProjectId:ie,updateProjectRates:Ie}){var q,J,K,Q,Z,ee,te;if(!re||!a||!c)return null;const[y,_]=r.useState(""),[D,A]=r.useState(""),[L,T]=r.useState(""),[o,M]=r.useState(null),[b,F]=r.useState(""),[d,I]=r.useState("even"),[P,h]=r.useState(""),[W,g]=r.useState(""),[E,$]=r.useState(!1),[j,G]=r.useState("TWD"),[O,H]=r.useState(""),[ce,S]=r.useState(!1),[v,B]=r.useState(""),R=(q=c.projects)==null?void 0:q.find(t=>t.id===ie),x=(R==null?void 0:R.type)==="private",i=c.users||{},u=Object.keys(i).find(t=>i[t].role==="host"),m=Object.keys(i).find(t=>i[t].role==="guest"),w=u&&((J=i[u])==null?void 0:J.name)||"戶長",C=m&&((K=i[m])==null?void 0:K.name)||"成員",de=(((Q=c.users)==null?void 0:Q[f==null?void 0:f.uid])||{}).favoriteCurrencies||ge;r.useEffect(()=>{var t;if(a){_(a.amount.toString()),A(a.note||""),G(a.currency||"TWD");try{const n=a.date?new Date(a.date):new Date;T(se(n))}catch{T(se())}F(a.payer);let s=a.splitType||"even";if(s==="custom"&&a.customSplit){const n=Object.keys(a.customSplit),he=a.payer;n.length===1?n[0]===he?s="self":s="partner":n.length>1&&(s="multi_payer")}I(s);const l=(t=a.category)==null?void 0:t.id,p=(c.customCategories||U).find(n=>n.id===l)||a.category||U[0];M(p),a.customSplit?(u&&a.customSplit[u]&&h(a.customSplit[u].toString()),m&&a.customSplit[m]&&g(a.customSplit[m].toString())):(h(""),g("")),h(""),g("")}H(a.paymentMethod||"")},[a,u,m,c.customCategories]),r.useEffect(()=>{x&&f&&(I("self"),F(f.uid))},[x,f]);const xe=async()=>{if(!(!y||parseFloat(y)<=0||E)){$(!0);try{const t=parseFloat(y);let s=null;if(!x&&(d==="custom"||d==="multi_payer")){const l=parseFloat(P)||0,p=parseFloat(W)||0;if(Math.abs(l+p-t)>.1){alert(`金額不符：分攤總和 (${l+p}) 必須等於總金額 (${t})`),$(!1);return}s={},u&&(s[u]=l),m&&(s[m]=p)}await ne({...a,amount:t,currency:j,category:o,note:D||o.name,date:new Date(L).toISOString(),payer:x?f.uid:b,splitType:x?"self":d,customSplit:x?null:s,paymentMethod:O}),N()}catch(t){console.error("Update failed",t),alert("更新失敗")}finally{$(!1)}}},ue=async()=>{if(window.confirm("確定要刪除這筆紀錄嗎？"))try{await oe(a.id),N()}catch(t){console.error(t)}},V=(t,s)=>{const l=parseFloat(y)||0,p=parseFloat(s)||0;if(d==="multi_payer")if(t==="host"){h(s);const n=l-p;g(n>=0?n.toString():"0")}else{g(s);const n=l-p;h(n>=0?n.toString():"0")}else t==="host"?h(s):g(s)},k=t=>{var l;const s=(l=i[b])==null?void 0:l.role;return t==="host"?s==="host"?`私人 (${w})`:s==="guest"?`代墊 (幫${w}付)`:`${w} 全額`:s==="guest"?`私人 (${C})`:s==="host"?`代墊 (幫${C}付)`:`${C} 全額`},me=v?z.filter(t=>t.code.includes(v.toUpperCase())||t.name.includes(v)):z,X=t=>{G(t),S(!1),B("")},Y=c.customCategories||U,pe=ye((o==null?void 0:o.icon)||"food"),fe=be(o,"input");return e.jsxs("div",{className:"fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:px-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity",onClick:N}),e.jsxs("div",{className:"bg-white w-full sm:w-[400px] sm:rounded-2xl rounded-t-3xl p-5 pb-8 max-h-[90vh] overflow-y-auto relative z-10 animate-slide-up",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800",children:"編輯紀錄"}),e.jsx("button",{onClick:N,className:"p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200",children:e.jsx(le,{size:20})})]}),e.jsx("div",{className:"flex justify-center mb-6 overflow-x-auto no-scrollbar",children:e.jsxs("div",{className:"text-4xl font-bold text-gray-900 flex items-center gap-2 px-4 mx-auto",children:[e.jsx("span",{className:"text-2xl text-gray-300 whitespace-nowrap",children:((Z=z.find(t=>t.code===j))==null?void 0:Z.symbol)||"$"}),e.jsx("input",{type:"number",value:y,onChange:t=>{parseFloat(t.target.value)>1e8||_(t.target.value)},className:"w-32 text-center outline-none bg-transparent placeholder-gray-200 min-w-[120px]",placeholder:"0"}),e.jsxs("button",{onClick:()=>S(!0),className:"flex items-center gap-1 text-sm font-bold bg-gray-100 rounded-lg px-3 py-1.5 text-gray-700 hover:bg-gray-200 transition-colors whitespace-nowrap shrink-0",children:[j," ",e.jsx(ae,{size:14})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("select",{value:o==null?void 0:o.id,onChange:t=>{const s=Y.find(l=>l.id===t.target.value);s&&M(s)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",children:Y.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))}),e.jsxs("div",{className:`flex items-center gap-2 px-3 py-3 rounded-xl border ${fe.activeClass} border-transparent flex-none min-w-[100px]`,children:[e.jsx(pe,{size:20}),e.jsx("span",{className:"font-bold text-sm truncate max-w-[60px]",children:o==null?void 0:o.name})]})]}),e.jsx("input",{type:"text",value:D,onChange:t=>A(t.target.value),placeholder:"備註...",className:"flex-1 bg-gray-50 px-4 rounded-xl border border-gray-100 outline-none text-sm font-medium focus:border-rose-200"})]}),e.jsxs("div",{className:"flex items-center bg-gray-50 px-4 py-3 rounded-xl border border-gray-100",children:[e.jsx(je,{size:18,className:"text-gray-400 mr-3"}),e.jsx("input",{type:"date",value:L,onChange:t=>T(t.target.value),className:"bg-transparent font-bold text-gray-700 outline-none w-full text-sm"})]}),!x&&e.jsxs("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-100 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx(Se,{size:16}),e.jsx("span",{className:"text-xs font-bold",children:"分攤模式"})]}),e.jsxs("select",{value:d,onChange:t=>I(t.target.value),className:"bg-white border border-gray-200 text-xs font-bold py-1 px-2 rounded-lg outline-none",children:[e.jsx("option",{value:"even",children:"平均分攤"}),e.jsx("option",{value:"multi_payer",children:"混合出資"}),e.jsx("option",{value:"self",children:((ee=i[b])==null?void 0:ee.role)==="host"?k("host"):k("guest")}),e.jsx("option",{value:"partner",children:((te=i[b])==null?void 0:te.role)==="host"?k("guest"):k("host")})]})]}),(d==="multi_payer"||d==="custom")&&e.jsxs("div",{className:"flex gap-2 animate-fade-in",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("span",{className:"absolute left-2 top-1/2 -translate-y-1/2 text-[10px] text-gray-400",children:w}),e.jsx("input",{type:"number",value:P,onChange:t=>V("host",t.target.value),className:"w-full pl-10 pr-2 py-2 text-xs rounded border border-gray-200 text-right outline-none"})]}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("span",{className:"absolute left-2 top-1/2 -translate-y-1/2 text-[10px] text-gray-400",children:C}),e.jsx("input",{type:"number",value:W,onChange:t=>V("guest",t.target.value),className:"w-full pl-10 pr-2 py-2 text-xs rounded border border-gray-200 text-right outline-none"})]})]}),e.jsx("div",{className:"h-[1px] bg-gray-200 w-full"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx(ve,{size:16}),e.jsx("span",{className:"text-xs font-bold",children:"付款人"})]}),e.jsx("div",{className:"flex gap-2 overflow-x-auto no-scrollbar max-w-[200px]",children:Object.keys(i).map(t=>e.jsx("button",{onClick:()=>F(t),className:`text-[10px] font-bold px-3 py-1 rounded-full border transition-colors whitespace-nowrap ${b===t?"bg-gray-800 text-white border-gray-800":"bg-white text-gray-500 border-gray-200"}`,children:i[t].name},t))})]}),d!=="multi_payer"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[1px] bg-gray-200 w-full"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx(we,{size:16}),e.jsx("span",{className:"text-xs font-bold",children:"支付方式"})]}),e.jsxs("div",{className:"relative w-40",children:[e.jsxs("select",{value:O,onChange:t=>H(t.target.value),className:`w-full appearance-none bg-white border border-gray-200 text-xs font-bold py-1 pl-2 pr-8 rounded-lg outline-none text-right ${O?"text-gray-700":"text-gray-400"}`,children:[e.jsx("option",{value:"",children:"未指定"}),(c.paymentMethods||[]).map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400",children:e.jsx(ae,{size:14})})]})]})]})]}),x&&e.jsxs("div",{className:"flex items-center justify-center gap-2 p-3 bg-slate-50 rounded-xl text-slate-400 border border-slate-100",children:[e.jsx(Ne,{size:12}),e.jsx("span",{className:"text-xs font-bold",children:"私人帳本模式 (不進行分攤)"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-8",children:[e.jsx("button",{onClick:ue,className:"p-4 rounded-2xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors",children:e.jsx(Ce,{size:24})}),e.jsxs("button",{onClick:xe,disabled:E,className:"flex-1 bg-gray-900 text-white font-bold rounded-2xl py-4 flex items-center justify-center gap-2 active:scale-95 transition-transform disabled:opacity-50",children:[E?e.jsx(ke,{className:"animate-spin"}):e.jsx(ze,{size:24}),"儲存變更"]})]}),ce&&e.jsxs("div",{className:"absolute inset-0 z-[70] flex flex-col justify-end",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity",onClick:()=>S(!1)}),e.jsxs("div",{className:"bg-white rounded-t-3xl p-6 relative z-10 max-h-[80vh] flex flex-col animate-slide-up shadow-2xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"選擇幣別"}),e.jsx("button",{onClick:()=>S(!1),className:"p-2 bg-gray-50 rounded-full",children:e.jsx(le,{size:20})})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(Te,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"搜尋貨幣...",value:v,onChange:t=>B(t.target.value),className:"w-full bg-gray-50 pl-10 pr-4 py-3 rounded-xl font-bold text-sm outline-none border border-transparent focus:bg-white focus:border-rose-200 transition-all"})]}),e.jsxs("div",{className:"overflow-y-auto space-y-6 flex-1",children:[!v&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-bold text-gray-400 uppercase mb-2",children:"常用貨幣"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:["TWD",...de.filter(t=>t!=="TWD")].map(t=>{const s=z.find(l=>l.code===t);return s?e.jsxs("button",{onClick:()=>X(t),className:`flex flex-col items-center justify-center gap-1 p-4 rounded-2xl border transition-all ${j===t?"bg-rose-50 border-rose-500 text-rose-600 ring-1 ring-rose-500":"bg-white border-gray-100 hover:border-gray-300"}`,children:[e.jsx("span",{className:"text-2xl",children:s.flag}),e.jsx("span",{className:"font-bold text-sm",children:t})]},t):null})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-bold text-gray-400 uppercase mb-2",children:"所有貨幣"}),e.jsx("div",{className:"space-y-2",children:me.map(t=>e.jsxs("button",{onClick:()=>X(t.code),className:"w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl transition-colors text-left",children:[e.jsx("span",{className:"text-2xl w-8 text-center",children:t.flag}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-bold text-gray-800",children:t.code}),e.jsx("div",{className:"text-xs text-gray-400",children:t.name})]}),j===t.code&&e.jsx(Fe,{size:18,className:"text-rose-500"})]},t.code))})]})]})]})]})]})]})}export{Me as default};
