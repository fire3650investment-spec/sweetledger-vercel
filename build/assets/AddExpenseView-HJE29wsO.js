import{c as T,r,j as e,f as nt,P as rt,U as ee,g as we,a as Ce,p as lt,b as ot,d as it,D as je,e as ct,I as dt,C as B,L as ve,S as xt,h as X,i as ut,k as mt}from"./index-B5DDJBRu.js";import{T as ft}from"./trash-2-DXibKo_E.js";import{C as Se}from"./check-BoE3d4y4.js";import{U as ke}from"./users-C90etpuH.js";import{X as te}from"./x-DSv-JPvv.js";import{R as Z}from"./refresh-cw-CH6ukssN.js";import{C as gt}from"./circle-alert-CU2mbdMD.js";import{C as ht}from"./credit-card-CqgDPj9_.js";import{R as pt}from"./repeat-IOWqz4qM.js";import{S as bt,C as yt}from"./search-8KuKs2XI.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jt=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],vt=T("camera",jt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["rect",{x:"9",y:"9",width:"6",height:"6",rx:"1",key:"1ssd4o"}]],wt=T("circle-stop",Nt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=[["path",{d:"M20 4v7a4 4 0 0 1-4 4H4",key:"6o5b7l"}],["path",{d:"m9 10-5 5 5 5",key:"1kshq7"}]],St=T("corner-down-left",Ct);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=[["path",{d:"M10 5a2 2 0 0 0-1.344.519l-6.328 5.74a1 1 0 0 0 0 1.481l6.328 5.741A2 2 0 0 0 10 19h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z",key:"1yo7s0"}],["path",{d:"m12 9 6 6",key:"anjzzh"}],["path",{d:"m18 9-6 6",key:"1fp51s"}]],Ne=T("delete",kt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=[["line",{x1:"5",x2:"19",y1:"9",y2:"9",key:"1nwqeh"}],["line",{x1:"5",x2:"19",y1:"15",y2:"15",key:"g8yjpy"}]],zt=T("equal",It);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const At=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],Rt=T("image",At);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],$t=T("mic",_t);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]],Ot=T("tag",Mt);function Tt({isOpen:x,onClose:i,onConfirm:f,initialItems:l=[],currency:g="TWD",users:b={}}){if(!x)return null;const[c,n]=r.useState([]),[h,d]=r.useState(null),[v,C]=r.useState(null);r.useEffect(()=>{const s=l.map((m,w)=>({id:Date.now()+w,name:m.name||"未命名品項",price:parseFloat(m.price)||0,quantity:m.quantity||1,owner:"shared"}));n(s);const a=Object.keys(b).find(m=>b[m].role==="host"),o=Object.keys(b).find(m=>b[m].role==="guest");d(a),C(o)},[l,b]);const $=s=>{n(a=>a.map(o=>{if(o.id!==s)return o;let m="shared";return o.owner==="shared"?m="host":o.owner==="host"?m="guest":m="shared",{...o,owner:m}}))},j=(s,a,o)=>{n(m=>m.map(w=>w.id!==s?w:{...w,[a]:o}))},z=s=>{n(a=>a.filter(o=>o.id!==s))},S=()=>{n(s=>[...s,{id:Date.now(),name:"新項目",price:0,quantity:1,owner:"shared"}])},A=()=>{let s=0,a=0,o=0;const m=[];c.forEach(M=>{const R=parseFloat(M.price);R&&(s+=R,m.push(M.name),M.owner==="host"?a+=R:M.owner==="guest"?o+=R:(a+=R/2,o+=R/2))});const w={amount:s,note:m.join(", "),splitType:"custom",customSplit:{}};h&&(w.customSplit[h]=a),v&&(w.customSplit[v]=o),f(w),i()},k=s=>{switch(s){case"host":return"bg-blue-50 border-blue-200 text-blue-700";case"guest":return"bg-pink-50 border-pink-200 text-pink-700";default:return"bg-white border-gray-100 text-gray-700"}},I=s=>s==="host"?e.jsx(ee,{size:16,className:"text-blue-500 fill-blue-100"}):s==="guest"?e.jsx(ee,{size:16,className:"text-pink-500 fill-pink-100"}):e.jsx(ke,{size:16,className:"text-gray-400"}),N=s=>{var a,o;return s==="host"?((a=b[h])==null?void 0:a.name)||"Host":s==="guest"?((o=b[v])==null?void 0:o.name)||"Guest":"平分"},u=c.reduce((s,a)=>s+(parseFloat(a.price)||0),0);return e.jsxs("div",{className:"fixed inset-0 z-[100] bg-gray-50 flex flex-col animate-in slide-in-from-bottom duration-300",children:[e.jsxs("div",{className:"bg-white px-4 py-3 border-b border-gray-100 flex justify-between items-center pt-[calc(env(safe-area-inset-top)+0.5rem)] shadow-sm shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-bold text-lg text-gray-800",children:"分帳掃描器"}),e.jsx("p",{className:"text-xs text-gray-400",children:"點擊項目切換歸屬"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xl font-bold text-gray-900",children:nt(u,g)}),e.jsx("div",{className:"text-[10px] text-gray-400 font-medium",children:"總金額"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3 pb-32",children:[c.map(s=>e.jsxs("div",{onClick:()=>$(s.id),className:`relative rounded-2xl border-2 p-3 transition-all active:scale-[0.98] duration-200 flex items-center justify-between shadow-sm ${k(s.owner)}`,children:[e.jsxs("div",{className:"flex-1 min-w-0 mr-4",onClick:a=>a.stopPropagation(),children:[e.jsx("input",{type:"text",value:s.name,onChange:a=>j(s.id,"name",a.target.value),className:"w-full bg-transparent font-bold text-sm mb-1 outline-none placeholder-gray-300",placeholder:"品項名稱"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-xs opacity-50",children:"$"}),e.jsx("input",{type:"number",value:s.price,onChange:a=>j(s.id,"price",a.target.value),className:"w-20 bg-transparent font-bold text-lg outline-none placeholder-gray-300",placeholder:"0"})]})]}),e.jsx("div",{className:"flex flex-col items-end gap-1 pointer-events-none",children:e.jsxs("div",{className:"flex items-center gap-1.5 bg-white/50 px-2 py-1 rounded-lg backdrop-blur-sm",children:[I(s.owner),e.jsx("span",{className:"text-xs font-bold",children:N(s.owner)})]})}),e.jsx("button",{onClick:a=>{a.stopPropagation(),z(s.id)},className:"absolute -top-2 -right-2 w-6 h-6 bg-red-100 text-red-500 rounded-full flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(ft,{size:12})})]},s.id)),e.jsxs("button",{onClick:S,className:"w-full py-4 rounded-2xl border-2 border-dashed border-gray-200 text-gray-400 font-bold flex items-center justify-center gap-2 hover:bg-gray-100 hover:border-gray-300 transition-all active:scale-95",children:[e.jsx(rt,{size:20}),"手動新增項目"]})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-[calc(env(safe-area-inset-bottom)+1rem)] flex gap-3 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]",children:[e.jsx("button",{onClick:i,className:"px-6 py-4 rounded-xl bg-gray-100 text-gray-500 font-bold active:scale-95 transition-transform",children:"取消"}),e.jsxs("button",{onClick:A,className:"flex-1 py-4 rounded-xl bg-gray-900 text-white font-bold text-lg flex items-center justify-center gap-2 shadow-lg shadow-gray-200 active:scale-95 transition-transform",children:[e.jsx(Se,{size:20}),"確認分帳"]})]})]})}const Et=r.memo(function({onKeyPress:i,isMathPending:f}){const l=(g,b="num",c="")=>{let n=g;return g==="DEL"?n=e.jsx(Ne,{size:22}):g==="DONE"&&(n=f?e.jsx(zt,{size:28}):e.jsx(St,{size:28,strokeWidth:3})),e.jsx("button",{onClick:h=>{h.stopPropagation(),i(g)},className:`
                rounded-2xl text-xl font-bold flex items-center justify-center select-none 
                active:scale-95 transition-transform 
                ${c} 
                ${b==="num"?"bg-white text-slate-700 shadow-[0_2px_0_#e2e8f0]":""} 
                ${b==="op"?"bg-rose-50 text-rose-500":""} 
                ${b==="action"?"bg-rose-500 text-white shadow-lg shadow-rose-200":""} 
            `,style:{height:"56px"},children:n})};return e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-gray-50 rounded-t-3xl z-50 animate-slide-up shadow-[0_-10px_40px_rgba(0,0,0,0.1)] pb-[env(safe-area-inset-bottom)]",children:[e.jsx("div",{className:"flex justify-center pt-2 pb-1",children:e.jsx("div",{className:"w-10 h-1 bg-gray-300 rounded-full"})}),e.jsxs("div",{className:"grid grid-cols-4 gap-3 p-4",children:[l("7")," ",l("8")," ",l("9")," ",l("+","op"),l("4")," ",l("5")," ",l("6")," ",l("-","op"),l("1")," ",l("2")," ",l("3")," ",l("×","op"),l("0")," ",l(".")," ",l("DONE","action","col-span-1")," ",l("÷","op")]}),e.jsx("div",{className:"px-4 pb-2 flex justify-end",children:e.jsxs("button",{onClick:()=>i("DEL"),className:"flex items-center gap-2 text-gray-400 font-bold px-4 py-2 rounded-lg active:bg-gray-200 transition-colors",children:[e.jsx(Ne,{size:18})," 刪除"]})})]})}),Ft=r.memo(function({categories:i,selectedCategory:f,onSelect:l}){return e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl z-50 animate-slide-up shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col max-h-[70vh]",children:[e.jsx("div",{className:"flex justify-center pt-3 pb-4 shrink-0",children:e.jsx("div",{className:"w-10 h-1 bg-gray-200 rounded-full"})}),e.jsx("div",{className:"px-6 mb-2 shrink-0",children:e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"選擇分類"})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 pt-0",children:e.jsx("div",{className:"grid grid-cols-4 gap-4 pb-[env(safe-area-inset-bottom)]",children:i.map(g=>{const b=we(g.icon),c=(f==null?void 0:f.id)===g.id,n=Ce(g,"input");return e.jsxs("button",{onClick:()=>l(g),className:"flex flex-col items-center gap-2 group p-1",children:[e.jsx("div",{className:`
                                w-14 h-14 rounded-3xl flex items-center justify-center transition-all shrink-0 border
                                ${c?n.activeClass:n.containerClass}
                                ${c?"scale-110 shadow-lg":"group-active:scale-95"}
                            `,children:e.jsx(b,{size:24,className:c?"text-white":n.iconClass})}),e.jsx("span",{className:`text-xs font-bold ${c?"text-gray-900":"text-gray-400"}`,children:g.name})]},g.id)})})})]})});function Lt({tags:x,onSelect:i}){return!x||x.length===0?null:e.jsx("div",{className:"flex gap-2 overflow-x-auto no-scrollbar mt-3 pb-1",children:x.map((f,l)=>e.jsxs("button",{onClick:()=>i(f),className:`
                    flex items-center gap-1 px-3 py-1.5 bg-gray-50 text-gray-500 text-xs rounded-xl border border-gray-100 
                    active:scale-95 transition-transform whitespace-nowrap font-medium 
                    hover:bg-rose-50 hover:text-rose-500 hover:border-rose-100
                `,children:[e.jsx(Ot,{size:10})," ",f]},l))})}function Dt(x){const[i,f]=r.useState(""),l=/[+\-×÷]/.test(i)&&!/[+\-×÷]$/.test(i),g=()=>{if(l){try{const c=i.replace(/×/g,"*").replace(/÷/g,"/"),n=new Function("return "+c)();let h=Math.round(n*100)/100;h>1e8&&(h=1e8),f(h.toString())}catch(c){console.error("Calculation error",c)}return}if(!(!i||parseFloat(i)<=0)){if(parseFloat(i)>1e8){f("100000000");return}x&&x()}},b=r.useCallback(c=>{if(navigator.vibrate)try{navigator.vibrate(10)}catch{}const n=["+","-","×","÷"];if(c==="AC"){f("");return}if(c==="DEL"){f(d=>d.slice(0,-1));return}if(c==="DONE"){g();return}const h=1e8;if(c==="."){f(d=>{const v=d.slice(-1);return!d||n.includes(v)?d+"0.":d.includes(".")&&!n.some(C=>d.lastIndexOf(C)>d.lastIndexOf("."))?d:d+c});return}f(d=>{const v=d.slice(-1);if(n.includes(c)){if(n.includes(v))return d.slice(0,-1)+c;if(!d)return d}const C=d+c;return!/[+\-×÷]/.test(C)&&parseFloat(C)>h?d:d+c})},[i,l]);return{localAmount:i,setLocalAmount:f,handleKeyPress:b,isMathPending:l,handleKeypadSubmit:g}}function Pt({setLocalAmount:x,setNote:i,setSplitType:f,setCustomSplitHost:l,setCustomSplitGuest:g,setActiveOverlay:b,hostId:c,guestId:n}){const[h,d]=r.useState(!1),[v,C]=r.useState(!1),[$,j]=r.useState([]),z=r.useRef(null),S=r.useRef(null);return{isScanning:h,isScanModalOpen:v,setIsScanModalOpen:C,scannedItems:$,cameraInputRef:z,fileInputRef:S,handleImageUpload:async u=>{var o;const s=(o=u.target.files)==null?void 0:o[0];if(!s)return;u.target.value="",d(!0);const a=new FileReader;a.onloadend=async()=>{try{const m=a.result.split(",")[1],w=await lt(m);d(!1),w&&Array.isArray(w)?(j(w),C(!0)):alert("掃描失敗，請再試一次或手動輸入")}catch(m){console.error("Scanning Error",m),d(!1),alert("掃描發生錯誤："+m.message)}},a.readAsDataURL(s)},handleCameraClick:()=>{var u;(u=z.current)==null||u.click()},handleAlbumClick:()=>{var u;(u=S.current)==null||u.click()},handleScanConfirm:u=>{const{amount:s,note:a,splitType:o,customSplit:m}=u;x&&x(s.toString()),i&&a&&i(a),f&&f(o),m&&(c&&m[c]&&l&&l(m[c].toString()),n&&m[n]&&g&&g(m[n].toString())),s>0&&b&&b("category")}}}function Ut({setLocalAmount:x,setNote:i,setCurrency:f,setSelectedCategory:l,currentCats:g,isPrivateProject:b,onSuccess:c}){const[n,h]=r.useState(!1),[d,v]=r.useState(""),[C,$]=r.useState(!1),[j,z]=r.useState(!1),S=r.useRef(null);return{isAiModalOpen:n,setIsAiModalOpen:h,aiModalInput:d,setAiModalInput:v,isAiProcessing:C,isRecording:j,toggleVoiceRecording:()=>{var I;if(j)(I=S.current)==null||I.stop(),z(!1);else{if(!window.webkitSpeechRecognition&&!window.SpeechRecognition){alert("您的瀏覽器不支援語音辨識");return}const N=window.SpeechRecognition||window.webkitSpeechRecognition,u=new N;u.lang="zh-TW",u.continuous=!0,u.interimResults=!0,u.onresult=s=>{let a="";for(let o=s.resultIndex;o<s.results.length;++o)s.results[o].isFinal&&(a+=s.results[o][0].transcript);a&&v(o=>o+a)},u.onerror=s=>{console.error("Speech error",s.error),z(!1)},S.current=u,u.start(),z(!0)}},handleAiModalSubmit:async()=>{if(!d)return;h(!1),$(!0);let I=`你是一個記帳助手。請分析使用者的輸入，並回傳一個 JSON 物件。
目前的日期是：${new Date().toLocaleString("zh-TW")}。
        可用的分類 ID: ${g.map(u=>u.id).join(", ")}
請解析：1. 金額(amount) 2. 類別 ID(categoryId) 3. 備註(note) 4. 幣別(currency, 預設 TWD)
        只回傳 JSON。`;b&&(I+=`
[重要指令] 此為「私人帳本」模式。請將所有交易視為使用者個人支出，不需要考慮分帳、代墊或AA制邏輯。`),d&&(I+=`
使用者文字: "${d}"`);const N=await ot(I,null);if($(!1),v(""),!N){alert("AI 無法解析");return}try{const u=N.match(/\{[\s\S]*\}/),s=u?u[0]:N,a=JSON.parse(s);if(a.amount&&x(a.amount.toString()),a.note&&i(a.note),a.currency&&f(a.currency),a.categoryId){const o=g.find(m=>m.id===a.categoryId);o&&l(o)}c&&c()}catch(u){console.error("AI Parse Error",u),alert("AI 解析失敗")}}}}function Wt({isOpen:x,onClose:i,inputValue:f,onInputChange:l,isRecording:g,onToggleRecording:b,onSubmit:c}){return x?e.jsxs("div",{className:"absolute inset-0 z-[60] bg-white/95 backdrop-blur-sm flex flex-col px-6 pb-6 pt-[calc(env(safe-area-inset-top)+3rem)] animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800",children:"AI 智慧輸入"}),e.jsx("button",{onClick:i,className:"p-2 bg-gray-100 rounded-full",children:e.jsx(te,{size:20})})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4",children:[e.jsx("textarea",{value:f,onChange:n=>l(n.target.value),placeholder:"例如：午餐吃拉麵 250元...",className:"w-full h-40 p-4 bg-gray-50 rounded-2xl text-lg outline-none resize-none border border-gray-200 focus:border-purple-500 transition-colors"}),e.jsx("div",{className:"flex justify-center gap-4 mt-auto mb-8",children:e.jsx("button",{onClick:b,className:`p-6 rounded-full transition-all ${g?"bg-red-50 text-red-500 scale-110 shadow-red-200":"bg-purple-50 text-purple-600 shadow-purple-200"} shadow-lg`,children:g?e.jsx(wt,{size:32}):e.jsx($t,{size:32})})}),e.jsx("button",{onClick:c,disabled:!f,className:"w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg mb-4",children:"開始分析"})]})]}):null}function es({ledgerData:x,user:i,currentProjectId:f,setView:l,addTransaction:g,isSubmittingTransaction:b,updateProjectRates:c}){var me,fe,ge,he,pe,be,ye;if(!x)return null;const n=(me=x.projects)==null?void 0:me.find(t=>t.id===f),h=(n==null?void 0:n.type)==="private",[d,v]=r.useState(""),[C,$]=r.useState(it()),[j,z]=r.useState(je[0]),[S,A]=r.useState("amount"),[k,I]=r.useState(()=>n!=null&&n.defaultCurrency?n.defaultCurrency:localStorage.getItem("sweet_last_currency")||"TWD"),[N,u]=r.useState("even"),[s,a]=r.useState(""),[o,m]=r.useState(""),[w,M]=r.useState(""),[R,Y]=r.useState(""),[F,Ie]=r.useState(!1),[se,ze]=r.useState("monthly"),[ae,Ae]=r.useState(""),[Re,ne]=r.useState(!1),[_e,V]=r.useState(!1),[D,re]=r.useState(""),q=r.useRef(null),Q=r.useMemo(()=>x.customCategories||je,[x.customCategories]),$e=(((fe=x.users)==null?void 0:fe[i==null?void 0:i.uid])||{}).favoriteCurrencies||ct,Me=r.useMemo(()=>{var p;const t=((p=x.settings)==null?void 0:p.selectedCategories)||dt.settings.selectedCategories;return Q.filter(y=>t.includes(y.id))},[Q,(ge=x.settings)==null?void 0:ge.selectedCategories]),_=x.users||{},P=Object.keys(_).find(t=>_[t].role==="host"),E=Object.keys(_).find(t=>_[t].role==="guest"),H=P&&((he=_[P])==null?void 0:he.name)||"戶長",G=E&&((pe=_[E])==null?void 0:pe.name)||"成員",le=((be=_[s])==null?void 0:be.role)==="host",{localAmount:O,setLocalAmount:oe,handleKeyPress:Oe,isMathPending:Te}=Dt(()=>A("category")),{isScanning:U,isScanModalOpen:Ee,setIsScanModalOpen:Fe,scannedItems:Le,cameraInputRef:De,fileInputRef:Pe,handleImageUpload:ie,handleCameraClick:Ue,handleAlbumClick:We,handleScanConfirm:Ve}=Pt({setLocalAmount:oe,setNote:v,setSplitType:u,setCustomSplitHost:M,setCustomSplitGuest:Y,setActiveOverlay:A,hostId:P,guestId:E}),{isAiModalOpen:qe,setIsAiModalOpen:ce,aiModalInput:He,setAiModalInput:Ge,isAiProcessing:de,isRecording:Ke,toggleVoiceRecording:Je,handleAiModalSubmit:Be}=Ut({setLocalAmount:oe,setNote:v,setCurrency:I,setSelectedCategory:z,currentCats:Q,isPrivateProject:h}),Xe=r.useMemo(()=>{if(!x.transactions||!j)return[];const p=x.transactions.slice(-50).reverse().filter(y=>y.category.id===j.id&&y.note).map(y=>y.note);return[...new Set(p)].slice(0,5)},[x.transactions,j]);r.useEffect(()=>{localStorage.setItem("sweet_last_currency",k)},[k]),r.useEffect(()=>{!s&&i&&a(i.uid)},[i,s]),r.useEffect(()=>{h?(u("self"),i&&a(i.uid)):N==="self"&&u("even")},[h,i]);const Ye=t=>{z(t),A("none"),setTimeout(()=>{var p;(p=q.current)==null||p.focus()},100)},Qe=async()=>{if(!O||parseFloat(O)<=0)return;const t=parseFloat(O);let p=null;if(N==="custom"||N==="multi_payer"){const y=parseFloat(w)||0,L=parseFloat(R)||0;if(Math.abs(y+L-t)>.1){alert(`雙方金額總和 (${y+L}) 必須等於支出總額 (${t})！`);return}p={},P&&(p[P]=y),E&&(p[E]=L)}l("dashboard");try{await g({amount:t,currency:k,category:j,payer:s||i.uid,splitType:N,customSplit:p,note:d||j.name,projectId:f,date:C,isSubscription:F,subCycle:se,subPayDay:ae,paymentMethod:o})}catch(y){console.error("Add Tx Error:",y)}},Ze=()=>{var t;A("amount"),(t=q.current)==null||t.blur()},et=()=>{var t;A("category"),(t=q.current)==null||t.blur()},K=()=>{A("none")},xe=(t,p)=>{const y=parseFloat(O)||0,L=parseFloat(p)||0;if(t==="host"){M(p);const W=y-L;Y(W>=0?W.toString():"0")}else{Y(p);const W=y-L;M(W>=0?W.toString():"0")}},tt=Ce(j,"input"),st=we((j==null?void 0:j.icon)||"food"),J=t=>{var y;const p=(y=_[s])==null?void 0:y.role;return t==="host"?p==="host"?`私人 (${H})`:p==="guest"?`代墊 (幫${H}付)`:`${H} 全額`:p==="guest"?`私人 (${G})`:p==="host"?`代墊 (幫${G}付)`:`${G} 全額`},at=D?B.filter(t=>t.code.includes(D.toUpperCase())||t.name.includes(D)):B,ue=async t=>{if(I(t),V(!1),re(""),t==="TWD")return;if(!((n==null?void 0:n.rates)||{})[t]){ne(!0);const y=await mt(t);y&&c&&await c(f,t,y),ne(!1)}};return e.jsxs("div",{className:"fixed inset-0 z-[50] flex flex-col h-[100dvh] bg-gray-50 overflow-hidden",children:[e.jsx("input",{type:"file",ref:De,accept:"image/*",capture:"environment",className:"hidden",onChange:ie}),e.jsx("input",{type:"file",ref:Pe,accept:"image/*",className:"hidden",onChange:ie}),e.jsx(Tt,{isOpen:Ee,onClose:()=>Fe(!1),onConfirm:Ve,initialItems:Le,currency:k,users:_}),e.jsxs("div",{className:"bg-white px-4 pb-3 pt-[calc(env(safe-area-inset-top)+0.5rem)] z-20 shrink-0 shadow-sm border-b border-gray-100 relative",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("button",{onClick:()=>l("dashboard"),className:"p-2 -ml-2 text-slate-400 hover:bg-slate-100 rounded-full transition-colors",children:e.jsx(te,{size:24})}),e.jsxs("div",{className:`font-bold text-sm px-3 py-1 rounded-full border flex items-center gap-2 ${h?"bg-gray-800 text-white border-gray-700":"text-slate-700 bg-gray-100 border-gray-200"}`,children:[h&&e.jsx(ve,{size:12}),(n==null?void 0:n.name)||"日常"]}),e.jsxs("div",{className:"flex gap-2 -mr-1",children:[e.jsx("button",{onClick:We,disabled:U,className:`w-9 h-9 rounded-full flex items-center justify-center transition-all ${U?"opacity-30":"bg-gray-100 text-gray-500 hover:bg-gray-200 active:scale-95"}`,children:e.jsx(Rt,{size:18,strokeWidth:2.5})}),e.jsx("button",{onClick:Ue,disabled:U,className:`w-9 h-9 rounded-full flex items-center justify-center transition-all ${U?"bg-blue-100 text-blue-600 animate-pulse":"bg-gray-100 text-gray-500 hover:bg-blue-50 hover:text-blue-500 active:scale-95"}`,children:U?e.jsx(Z,{className:"animate-spin",size:18}):e.jsx(vt,{size:18,strokeWidth:2.5})}),e.jsxs("button",{onClick:()=>ce(!0),className:`h-9 px-3 rounded-full flex items-center justify-center gap-1.5 transition-all ${de?"bg-purple-100 text-purple-600":"bg-purple-50 text-purple-600 hover:bg-purple-100 active:scale-95"}`,children:[de?e.jsx(Z,{className:"animate-spin",size:16}):e.jsx(xt,{size:16,strokeWidth:2.5}),e.jsx("span",{className:"text-xs font-bold whitespace-nowrap",children:"AI 記帳"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:()=>V(!0),className:"flex items-center gap-1.5 bg-gray-100 rounded-lg px-3 py-1.5 border border-gray-200 active:bg-gray-200 transition-colors",children:[e.jsx("span",{className:"text-sm font-bold text-gray-800",children:k}),Re?e.jsx(Z,{className:"animate-spin w-3 h-3 text-rose-500 ml-1"}):e.jsx(X,{size:14,className:"text-gray-400"})]}),e.jsxs("div",{className:"flex-1 bg-gray-100 border border-gray-200 rounded-lg flex items-center px-3 py-1.5 text-slate-600 relative",children:[e.jsx(ut,{size:14,className:"mr-2 opacity-50"}),e.jsx("input",{type:"date",value:C,onChange:t=>$(t.target.value),className:"bg-transparent text-xs font-bold w-full outline-none z-10 text-gray-700"})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto overscroll-contain pb-32",children:[e.jsxs("div",{className:"px-4 py-6 bg-white mb-3 shadow-sm border-b border-gray-100",children:[e.jsx("div",{className:"flex justify-center mb-6 overflow-x-auto no-scrollbar",children:e.jsxs("button",{onClick:Ze,className:`text-5xl font-bold tracking-tight flex items-center transition-all px-4 mx-auto ${O?"text-gray-900":"text-gray-300"} ${S==="amount"?"scale-105":""}`,children:[e.jsx("span",{className:"text-2xl mr-2 text-gray-300 font-medium whitespace-nowrap",children:((ye=B.find(t=>t.code===k))==null?void 0:ye.symbol)||"$"}),e.jsx("span",{className:"whitespace-nowrap",children:O||"0"}),S==="amount"&&e.jsx("div",{className:"w-[3px] h-10 bg-rose-500 animate-cursor-blink ml-1 rounded-full shrink-0"})]})}),e.jsxs("div",{className:"flex gap-3 mb-4",children:[e.jsxs("button",{onClick:et,className:`flex-none w-[35%] flex items-center gap-2 p-3 rounded-2xl border transition-all ${S==="category"?"bg-rose-50 border-rose-200 ring-2 ring-rose-100":"bg-gray-50 border-gray-100"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center shadow-sm shrink-0 transition-colors ${j?tt.activeClass:"bg-white text-rose-500"}`,children:e.jsx(st,{size:18})}),e.jsxs("div",{className:"flex-1 min-w-0 text-left",children:[e.jsx("div",{className:"text-[10px] text-gray-400",children:"分類"}),e.jsx("div",{className:"font-bold text-gray-700 text-sm truncate",children:j==null?void 0:j.name})]}),e.jsx(X,{size:14,className:"text-gray-400 shrink-0"})]}),e.jsx("div",{className:"flex-1 bg-gray-50 rounded-2xl border border-gray-100 flex items-center px-4 focus-within:border-rose-200 focus-within:ring-2 focus-within:ring-rose-50 transition-all",children:e.jsx("input",{ref:q,type:"text",value:d,onChange:t=>v(t.target.value),maxLength:50,onFocus:K,placeholder:"寫點備註...",className:"w-full bg-transparent outline-none text-sm text-gray-700 placeholder-gray-400 font-medium"})})]}),e.jsx(Lt,{tags:Xe,onSelect:v})]}),e.jsx("div",{className:"px-4",children:e.jsxs("div",{className:"bg-white rounded-3xl p-5 shadow-sm border border-gray-100 space-y-5",children:[h?e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-3 text-gray-500",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500",children:e.jsx(ve,{size:16})}),e.jsx("span",{className:"text-sm font-bold",children:"私人記帳模式"})]}),e.jsx("span",{className:"text-xs font-bold text-gray-400 bg-white px-2 py-1 rounded border border-gray-100",children:"不進行分攤"})]}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-500",children:e.jsx(ke,{size:16})}),e.jsx("span",{className:"text-sm font-bold",children:"分攤模式"})]}),e.jsxs("div",{className:"relative w-40",children:[e.jsxs("select",{value:N,onChange:t=>u(t.target.value),className:"w-full appearance-none bg-gray-50 text-xs font-bold text-gray-700 py-2 pl-3 pr-8 rounded-xl outline-none border border-gray-100 focus:border-blue-200 text-right",children:[e.jsx("option",{value:"even",children:"平均分攤"}),e.jsx("option",{value:"multi_payer",children:"混合出資"}),e.jsx("option",{value:"self",children:J(le?"host":"guest")}),e.jsx("option",{value:"partner",children:J(le?"guest":"host")})]}),e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400",children:e.jsx(X,{size:14})})]})]}),N==="multi_payer"&&!h&&e.jsxs("div",{className:"bg-rose-50 p-3 rounded-xl border border-rose-100 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-2",children:[e.jsx(gt,{size:12,className:"text-rose-500"}),e.jsx("p",{className:"text-[10px] text-rose-500 font-bold text-center",children:"輸入雙方「當下實際支付」的金額"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-400 max-w-[4rem] truncate",children:H}),e.jsx("input",{type:"number",value:w,onChange:t=>xe("host",t.target.value),onFocus:K,className:"w-full py-2 pl-16 pr-2 bg-white rounded-lg text-sm text-right font-bold outline-none border border-gray-200 focus:border-blue-300"})]}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-400 max-w-[4rem] truncate",children:G}),e.jsx("input",{type:"number",value:R,onChange:t=>xe("guest",t.target.value),onFocus:K,disabled:!E,placeholder:E?"":"N/A",className:"w-full py-2 pl-16 pr-2 bg-white rounded-lg text-sm text-right font-bold outline-none border border-gray-200 focus:border-blue-300 disabled:bg-gray-100"})]})]})]}),N!=="multi_payer"&&!h&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[1px] bg-gray-50 w-full"}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 flex-1 min-w-0",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-500 shrink-0",children:e.jsx(ee,{size:16})}),e.jsx("span",{className:"text-sm font-bold shrink-0",children:"付款人"}),e.jsx("div",{className:"flex gap-2 overflow-x-auto no-scrollbar py-1 ml-auto",children:Object.keys(x.users||{}).map(t=>e.jsx("button",{onClick:()=>a(t),className:`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all border ${s===t?"bg-gray-900 text-white border-gray-900 shadow-sm":"bg-white text-gray-400 border-gray-200"}`,children:x.users[t].name},t))})]})})]}),N!=="multi_payer"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[1px] bg-gray-50 w-full"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-500",children:e.jsx(ht,{size:16})}),e.jsx("span",{className:"text-sm font-bold",children:"支付方式"})]}),e.jsxs("div",{className:"relative w-40",children:[e.jsxs("select",{value:o,onChange:t=>m(t.target.value),className:`w-full appearance-none bg-gray-50 text-xs font-bold py-2 pl-3 pr-8 rounded-xl outline-none border border-gray-100 focus:border-blue-200 text-right ${o?"text-gray-700":"text-gray-400"}`,children:[e.jsx("option",{value:"",children:"未指定"}),(x.paymentMethods||[]).map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400",children:e.jsx(X,{size:14})})]})]})]}),e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>Ie(!F),className:`w-full flex items-center justify-between p-3 rounded-xl border transition-all ${F?"bg-rose-50 border-rose-200":"bg-white border-gray-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-500 shrink-0",children:e.jsx(pt,{size:16})}),e.jsx("span",{className:`text-sm font-bold ${F?"text-rose-600":"text-gray-500"}`,children:"設為固定支出 (訂閱/分期)"})]}),e.jsx("div",{className:`w-4 h-4 rounded-full border ${F?"bg-rose-500 border-rose-500":"bg-transparent border-gray-300"}`})]}),F&&e.jsxs("div",{className:"flex items-center gap-2 mt-3 pl-2 animate-fade-in justify-end",children:[e.jsx("span",{className:"text-xs text-gray-400 font-bold",children:"每"}),e.jsxs("select",{value:se,onChange:t=>ze(t.target.value),className:"bg-gray-100 text-gray-700 text-xs py-1 px-2 rounded-lg outline-none font-bold",children:[e.jsx("option",{value:"monthly",children:"月"}),e.jsx("option",{value:"weekly",children:"週"})]}),e.jsx("input",{type:"number",placeholder:"日",value:ae,onChange:t=>Ae(t.target.value),onFocus:K,className:"w-12 bg-gray-100 text-gray-700 p-1 rounded-lg text-xs text-center font-bold outline-none"}),e.jsx("span",{className:"text-xs text-gray-400 font-bold",children:"號扣款"})]})]})]})})]}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-100 pb-[calc(env(safe-area-inset-bottom)+1rem)] z-30",children:e.jsxs("button",{onClick:Qe,disabled:!O||parseFloat(O)<=0,className:"w-full bg-gray-900 text-white text-lg font-bold py-4 rounded-2xl shadow-lg shadow-gray-200 active:scale-95 transition-transform flex items-center justify-center gap-2 disabled:opacity-50 disabled:shadow-none",children:[e.jsx(Se,{size:24}),S==="category"?"完成記帳":"下一步"]})}),S==="amount"&&e.jsx(Et,{onKeyPress:Oe,isMathPending:Te}),S==="category"&&e.jsx(Ft,{categories:Me,selectedCategory:j,onSelect:Ye}),e.jsx(Wt,{isOpen:qe,onClose:()=>ce(!1),inputValue:He,onInputChange:Ge,isRecording:Ke,onToggleRecording:Je,onSubmit:Be}),_e&&e.jsxs("div",{className:"absolute inset-0 z-[70] flex flex-col justify-end",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity",onClick:()=>V(!1)}),e.jsxs("div",{className:"bg-white rounded-t-3xl p-6 relative z-10 max-h-[80vh] flex flex-col animate-slide-up",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"選擇幣別"}),e.jsx("button",{onClick:()=>V(!1),className:"p-2 bg-gray-50 rounded-full",children:e.jsx(te,{size:20})})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(bt,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"搜尋貨幣 (例如: USD)",value:D,onChange:t=>re(t.target.value),className:"w-full bg-gray-50 pl-10 pr-4 py-3 rounded-xl font-bold text-sm outline-none border border-transparent focus:bg-white focus:border-rose-200 transition-all"})]}),e.jsxs("div",{className:"overflow-y-auto space-y-6",children:[!D&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-bold text-gray-400 uppercase mb-2",children:"常用貨幣"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:["TWD",...$e.filter(t=>t!=="TWD")].map(t=>{const p=B.find(y=>y.code===t);return p?e.jsxs("button",{onClick:()=>ue(t),className:`flex flex-col items-center justify-center gap-1 p-4 rounded-2xl border transition-all ${k===t?"bg-rose-50 border-rose-500 text-rose-600 ring-1 ring-rose-500":"bg-white border-gray-100 hover:border-gray-300"}`,children:[e.jsx("span",{className:"text-2xl",children:p.flag}),e.jsx("span",{className:"font-bold text-sm",children:t})]},t):null})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-bold text-gray-400 uppercase mb-2",children:"所有貨幣"}),e.jsx("div",{className:"space-y-2",children:at.map(t=>e.jsxs("button",{onClick:()=>ue(t.code),className:"w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl transition-colors text-left group",children:[e.jsx("span",{className:"text-2xl w-8 text-center",children:t.flag}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-bold text-gray-800",children:t.code}),e.jsx("div",{className:"text-xs text-gray-400",children:t.name})]}),k===t.code&&e.jsx(yt,{size:18,className:"text-rose-500"})]},t.code))})]})]})]})]})]})}export{es as default};
